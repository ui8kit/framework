<!DOCTYPE html>
<html>
<head>
  <title>Test Browser UnCSS</title>
</head>
<body>
  <h1>Testing Browser UnCSS</h1>
  <div id="test-output"></div>

  <script type="module">
    // Test version of BrowserUnCSS
    class BrowserUnCSS {
      static async process(html, css) {
        try {
          // Parse HTML
          const parser = new DOMParser()
          const doc = parser.parseFromString(html, 'text/html')

          // Extract selectors from CSS
          const cssSelectors = this.extractSelectorsFromCSS(css)

          // Check which selectors are used
          const usedSelectors = new Set()

          cssSelectors.forEach(selector => {
            try {
              const elements = doc.querySelectorAll(selector)
              if (elements.length > 0) {
                usedSelectors.add(selector)
                console.log(`‚úÖ Used: ${selector}`)
              } else {
                console.log(`‚ùå Unused: ${selector}`)
              }
            } catch (e) {
              console.log(`‚ö†Ô∏è  Invalid selector: ${selector}`)
            }
          })

          // Generate clean CSS
          return this.generateCleanCSS(css, usedSelectors)
        } catch (error) {
          throw new Error(`UnCSS processing failed: ${error.message}`)
        }
      }

      static extractSelectorsFromCSS(css) {
        const selectors = []
        const rules = css.split('}')

        rules.forEach(rule => {
          const parts = rule.split('{')
          if (parts.length === 2) {
            const selectorPart = parts[0].trim()
            if (selectorPart) {
              const individualSelectors = selectorPart.split(',').map(s => s.trim())
              selectors.push(...individualSelectors)
            }
          }
        })

        return selectors
      }

      static generateCleanCSS(originalCSS, usedSelectors) {
        const rules = originalCSS.split('}')
        const cleanRules = []

        rules.forEach(rule => {
          const parts = rule.split('{')
          if (parts.length === 2) {
            const selectorPart = parts[0].trim()
            const declarationPart = parts[1].trim()

            if (selectorPart && declarationPart) {
              const selectors = selectorPart.split(',').map(s => s.trim())
              const hasUsedSelector = selectors.some(sel => usedSelectors.has(sel))

              if (hasUsedSelector) {
                cleanRules.push(`${selectorPart} {${declarationPart}}`)
              }
            }
          }
        })

        return cleanRules.join('\n\n') + '\n'
      }
    }
    
    const testHTML = `
    <!DOCTYPE html>
    <html>
    <body>
      <div class="container">
        <h1 class="title">Hello World</h1>
        <p class="text">This is a test</p>
        <button class="btn btn-primary">Click me</button>
        <button class="btn btn-secondary">Cancel</button>
      </div>
    </body>
    </html>
    `

    const testCSS = `
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .title {
      color: #333;
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .text {
      color: #666;
      line-height: 1.6;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    /* Unused styles */
    .unused-class {
      color: red;
      font-weight: bold;
    }

    .another-unused {
      background: yellow;
      padding: 50px;
    }

    .not-used-at-all {
      border: 5px solid black;
    }
    `

    // Run test
    console.log('üß™ Testing Browser UnCSS...')
    console.log('Input CSS length:', testCSS.length)

    BrowserUnCSS.process(testHTML, testCSS).then(result => {
      console.log('‚úÖ Processing complete!')
      console.log('Output CSS length:', result.length)
      console.log('Result:')
      console.log(result)

      // Display result on page
      const output = document.getElementById('test-output')
      output.innerHTML = `
        <h2>Test Results</h2>
        <p><strong>Input CSS:</strong> ${testCSS.split('\n').filter(line => line.trim()).length} rules</p>
        <p><strong>Output CSS:</strong> ${result.split('\n').filter(line => line.trim()).length} rules</p>
        <h3>Optimized CSS:</h3>
        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px;">${result}</pre>
      `
    }).catch(error => {
      console.error('‚ùå Error:', error)
      document.getElementById('test-output').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`
    })
  </script>
</body>
</html>